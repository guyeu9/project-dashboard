# å¯¹è±¡å­˜å‚¨ vs æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

## é¡¹ç›®èƒŒæ™¯

å½“å‰é¡¹ç›®æ˜¯ä¸€ä¸ª**äº’è”ç½‘è”è°ƒæ’æœŸç®¡ç†å¹³å°**ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒå®ä½“ï¼š

### æ•°æ®ç»“æ„æ¦‚è§ˆ

1. **Projectï¼ˆé¡¹ç›®ï¼‰** - 13ä¸ªå­—æ®µ
   - åŸºæœ¬ä¿¡æ¯ï¼šid, name, status, progress, startDate, endDate
   - äººå‘˜ï¼špartners[], developers[], testers[], owner, productManager, pmo
   - æ‰©å±•ï¼šremark, chatGroupLinks[], contacts[], dailyProgress[]

2. **Taskï¼ˆä»»åŠ¡ï¼‰** - 12ä¸ªå­—æ®µ
   - åŸºæœ¬ä¿¡æ¯ï¼šid, projectId, name, type, status, progress, startDate, endDate
   - æ‰§è¡Œï¼šassignees[], dailyRecords[]
   - æ‰©å±•ï¼šdailyProgress, remark

3. **TaskTypeï¼ˆä»»åŠ¡ç±»å‹ï¼‰** - 4ä¸ªå­—æ®µ
   - id, name, color, enabled

4. **PMOï¼ˆPMOäººå‘˜ï¼‰** - 3ä¸ªå­—æ®µ
   - id, name, enabled

5. **ProductManagerï¼ˆäº§å“ç»ç†ï¼‰** - 3ä¸ªå­—æ®µ
   - id, name, enabled

6. **HistoryRecordï¼ˆå†å²è®°å½•ï¼‰** - 8ä¸ªå­—æ®µ
   - id, entityType, entityId, entityName, operation, operator, operatedAt, changes, projectId

### æ•°æ®å…³ç³»

```
Project (1) â”€â”€â”¬â”€â”€ (N) Task
              â”‚
              â”œâ”€â”€ (N) HistoryRecord
              â”‚
              â”œâ”€â”€ (1) ProductManager
              â”‚
              â””â”€â”€ (1) PMO

Task (N) â”€â”€â”€ (1) TaskType
```

---

## å­˜å‚¨éœ€æ±‚åˆ†æ

### åŠŸèƒ½éœ€æ±‚
1. âœ… **CRUD æ“ä½œ**ï¼šé¢‘ç¹çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤
2. âœ… **å…³è”æŸ¥è¯¢**ï¼šæ ¹æ® projectId æŸ¥è¯¢ç›¸å…³ä»»åŠ¡
3. âœ… **æ’åºè¿‡æ»¤**ï¼šæŒ‰æ—¥æœŸã€çŠ¶æ€ã€è¿›åº¦ç­‰æ¡ä»¶æ’åºå’Œè¿‡æ»¤
4. âœ… **å¹¶å‘æ§åˆ¶**ï¼šå¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘æ—¶éœ€è¦åŠ é”
5. âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿é¡¹ç›®å’Œä»»åŠ¡æ•°æ®çš„å®Œæ•´æ€§
6. âœ… **å†å²è¿½è¸ª**ï¼šè®°å½•æ‰€æœ‰æ“ä½œçš„å†å²è®°å½•
7. âœ… **äº‹åŠ¡æ”¯æŒ**ï¼šæŸäº›æ“ä½œéœ€è¦åŸå­æ€§ï¼ˆå¦‚åˆ›å»ºé¡¹ç›®æ—¶åŒæ—¶åˆ›å»ºä»»åŠ¡ï¼‰

### æ€§èƒ½éœ€æ±‚
1. âœ… **ä½å»¶è¿Ÿ**ï¼šå‰ç«¯éœ€è¦å¿«é€Ÿå“åº”
2. âœ… **é«˜å¹¶å‘**ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œ
3. âœ… **æ•°æ®æŒä¹…åŒ–**ï¼šæœåŠ¡å™¨é‡å¯åæ•°æ®ä¸ä¸¢å¤±
4. âœ… **å¯é å­˜å‚¨**ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±

---

## æ–¹æ¡ˆä¸€ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆS3 Storageï¼‰

### é›†æˆä¿¡æ¯
- **é›†æˆ ID**ï¼š`integration-s3-storage`
- **SDK**ï¼š`S3Storage` from `coze-coding-dev-sdk`
- **é€‚ç”¨åœºæ™¯**ï¼šéç»“æ„åŒ–æ•°æ®å­˜å‚¨ï¼ˆæ–‡ä»¶ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰

### æ ¸å¿ƒèƒ½åŠ›
```typescript
// ä¸Šä¼ æ–‡ä»¶
const key = await storage.uploadFile({
  fileContent: Buffer.from(jsonString),
  fileName: "data/project-data.json",
  contentType: "application/json",
});

// è¯»å–æ–‡ä»¶
const data = await storage.readFile({ fileKey: key });

// åˆ é™¤æ–‡ä»¶
const ok = await storage.deleteFile({ fileKey: key });

// åˆ—å‡ºå¯¹è±¡
const result = await storage.listFiles({ prefix: "data/", maxKeys: 100 });
```

### ä¼˜ç‚¹
âœ… **é€‚åˆå­˜å‚¨æ–‡ä»¶**ï¼šå›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ç­‰
âœ… **æˆæœ¬ä½**ï¼šæŒ‰ä½¿ç”¨é‡è®¡è´¹
âœ… **å¯æ‰©å±•æ€§å¼º**ï¼šæ— é™å®¹é‡
âœ… **é«˜å¯ç”¨æ€§**ï¼š99.99%+ å¯ç”¨æ€§
âœ… **æ˜“äºè¿ç§»**ï¼šæ ‡å‡† S3 API

### ç¼ºç‚¹
âŒ **ä¸é€‚åˆç»“æ„åŒ–æ•°æ®**ï¼šæ— æ³•æ‰§è¡Œ SQL æŸ¥è¯¢
âŒ **æ— å…³è”æŸ¥è¯¢**ï¼šæ— æ³• JOIN å¤šä¸ªè¡¨
âŒ **æ— æ’åºè¿‡æ»¤**ï¼šæ— æ³•æŒ‰å­—æ®µæ’åºæˆ–è¿‡æ»¤
âŒ **æ— ç´¢å¼•æ”¯æŒ**ï¼šæŸ¥è¯¢æ•ˆç‡ä½
âŒ **æ— äº‹åŠ¡æ”¯æŒ**ï¼šæ— æ³•ä¿è¯åŸå­æ€§
âŒ **è¯»å†™æ€§èƒ½å·®**ï¼šéœ€è¦ä¸‹è½½å®Œæ•´æ–‡ä»¶æ‰èƒ½è¯»å–
âŒ **å¹¶å‘æ§åˆ¶å¤æ‚**ï¼šéœ€è¦è‡ªå·±å®ç°é”æœºåˆ¶
âŒ **æ•°æ®ä¸€è‡´æ€§å·®**ï¼šå®¹æ˜“å‡ºç°å¹¶å‘å†²çª

### å®ç°å¤æ‚åº¦

#### æ•°æ®æ¨¡å‹è®¾è®¡
éœ€è¦å°†æ‰€æœ‰æ•°æ®å­˜å‚¨ä¸º JSON æ–‡ä»¶ï¼š

```
bucket/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ projects.json          # æ‰€æœ‰é¡¹ç›®
â”‚   â”œâ”€â”€ tasks.json             # æ‰€æœ‰ä»»åŠ¡
â”‚   â”œâ”€â”€ taskTypes.json         # ä»»åŠ¡ç±»å‹
â”‚   â”œâ”€â”€ pmos.json              # PMOäººå‘˜
â”‚   â”œâ”€â”€ productManagers.json   # äº§å“ç»ç†
â”‚   â””â”€â”€ historyRecords.json    # å†å²è®°å½•
```

#### æŸ¥è¯¢æ“ä½œç¤ºä¾‹
```typescript
// âŒ æŸ¥è¯¢æŸä¸ªé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡
async function getTasksByProjectId(projectId: string) {
  const tasksJson = await storage.readFile({ fileKey: "data/tasks.json" });
  const tasks = JSON.parse(tasksJson.toString());
  // å¿…é¡»ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ï¼Œç„¶åå†…å­˜è¿‡æ»¤
  return tasks.filter((t: Task) => t.projectId === projectId);
}
```

#### å¹¶å‘æ§åˆ¶ç¤ºä¾‹
```typescript
// âŒ æ›´æ–°é¡¹ç›®éœ€è¦åŠ é”
async function updateProject(project: Project) {
  const lockKey = `locks/project-${project.id}`;
  // è‡ªå·±å®ç°é”æœºåˆ¶
  const lockAcquired = await acquireLock(lockKey);
  if (!lockAcquired) {
    throw new Error("è·å–é”å¤±è´¥");
  }

  try {
    // è¯»å–ã€ä¿®æ”¹ã€å†™å…¥
    const dataJson = await storage.readFile({ fileKey: "data/projects.json" });
    const projects = JSON.parse(dataJson.toString());
    const index = projects.findIndex((p: Project) => p.id === project.id);
    projects[index] = project;
    await storage.uploadFile({
      fileContent: Buffer.from(JSON.stringify(projects)),
      fileName: "data/projects.json",
    });
  } finally {
    await releaseLock(lockKey);
  }
}
```

### æ€§èƒ½ä¼°ç®—

å‡è®¾ï¼š
- 100 ä¸ªé¡¹ç›®
- æ¯ä¸ª 10 ä¸ªä»»åŠ¡ = 1000 ä¸ªä»»åŠ¡
- æ¯æ¬¡æŸ¥è¯¢éœ€è¦ä¸‹è½½ 100KB æ•°æ®

| æ“ä½œ | å»¶è¿Ÿ | æ•°æ®é‡ | å¤æ‚åº¦ |
|------|------|--------|--------|
| è¯»å–æ‰€æœ‰é¡¹ç›® | ~500ms | 100KB | O(n) |
| æŸ¥è¯¢å•ä¸ªé¡¹ç›®ä»»åŠ¡ | ~500ms | 200KB | O(n) |
| æ›´æ–°é¡¹ç›® | ~1000ms | 200KB | O(n) + é” |
| æŒ‰çŠ¶æ€è¿‡æ»¤ | ~500ms | 200KB | O(n) |

**ç»“è®º**ï¼šéšç€æ•°æ®é‡å¢é•¿ï¼Œæ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚

---

## æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“å­˜å‚¨ï¼ˆPostgreSQL + Drizzle ORMï¼‰

### é›†æˆä¿¡æ¯
- **é›†æˆ ID**ï¼š`integration-postgre-database`
- **SDK**ï¼š`getDb()` from `coze-coding-dev-sdk`
- **ORM**ï¼šDrizzle ORM
- **é€‚ç”¨åœºæ™¯**ï¼šç»“æ„åŒ–æ•°æ®å­˜å‚¨ã€å…³ç³»å‹æ•°æ®

### æ ¸å¿ƒèƒ½åŠ›
```typescript
// æŸ¥è¯¢
const db = await getDb();
const projects = await db.select().from(projects);

// å…³è”æŸ¥è¯¢
const tasks = await db
  .select()
  .from(tasks)
  .where(eq(tasks.projectId, projectId));

// äº‹åŠ¡
await db.transaction(async (tx) => {
  await tx.insert(projects).values(projectData);
  await tx.insert(tasks).values(taskData);
});
```

### ä¼˜ç‚¹
âœ… **ä¸“ä¸ºç»“æ„åŒ–æ•°æ®è®¾è®¡**ï¼šå®Œç¾çš„æ”¯æŒ
âœ… **å…³è”æŸ¥è¯¢**ï¼šJOIN å¤šä¸ªè¡¨ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜
âœ… **æ’åºè¿‡æ»¤**ï¼šORDER BYã€WHERE å­å¥
âœ… **ç´¢å¼•æ”¯æŒ**ï¼šå¤§å¹…æå‡æŸ¥è¯¢æ€§èƒ½
âœ… **äº‹åŠ¡æ”¯æŒ**ï¼šACID ç‰¹æ€§ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
âœ… **è¯»å†™æ€§èƒ½é«˜**ï¼šæ¯«ç§’çº§å“åº”
âœ… **å¹¶å‘æ§åˆ¶**ï¼šæ•°æ®åº“å†…ç½®é”æœºåˆ¶
âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šå¤–é”®çº¦æŸã€å”¯ä¸€çº¦æŸ
âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ å­—æ®µã€ç´¢å¼•ã€çº¦æŸ
âœ… **æ”¯æŒå¤æ‚æŸ¥è¯¢**ï¼šèšåˆã€åˆ†ç»„ã€å­æŸ¥è¯¢

### ç¼ºç‚¹
âŒ **ä¸é€‚åˆå­˜å‚¨å¤§æ–‡ä»¶**ï¼šå›¾ç‰‡ã€è§†é¢‘ç­‰
âŒ **éœ€è¦å­¦ä¹  SQL**ï¼šæœ‰ä¸€å®šçš„å­¦ä¹ æ›²çº¿
âŒ **éœ€è¦è®¾è®¡ Schema**ï¼šéœ€è¦æå‰è®¾è®¡è¡¨ç»“æ„

### å®ç°å¤æ‚åº¦

#### æ•°æ®æ¨¡å‹è®¾è®¡
```typescript
// schema.ts
export const projects = pgTable("projects", {
  id: varchar("id", { length: 36 }).primaryKey(),
  name: varchar("name", { length: 255 }).notNull(),
  status: varchar("status", { length: 20 }).notNull(),
  progress: integer("progress").notNull().default(0),
  startDate: timestamp("start_date", { withTimezone: true }),
  endDate: timestamp("end_date", { withTimezone: true }),
  // ... å…¶ä»–å­—æ®µ
});

export const tasks = pgTable("tasks", {
  id: varchar("id", { length: 36 }).primaryKey(),
  projectId: varchar("project_id", { length: 36 }).notNull(),
  name: varchar("name", { length: 255 }).notNull(),
  type: jsonb("type").notNull(),  // TaskType å¯¹è±¡
  status: varchar("status", { length: 20 }).notNull(),
  progress: integer("progress").notNull().default(0),
  // ... å…¶ä»–å­—æ®µ
});
```

#### Manager å±‚å°è£…
```typescript
// projectManager.ts
export class ProjectManager {
  async getProjectById(id: string): Promise<Project | null> {
    const db = await getDb();
    const [project] = await db.select().from(projects).where(eq(projects.id, id));
    return project || null;
  }

  async getProjectTasks(projectId: string): Promise<Task[]> {
    const db = await getDb();
    return db.select().from(tasks).where(eq(tasks.projectId, projectId));
  }

  async createProject(project: InsertProject): Promise<Project> {
    const db = await getDb();
    const [newProject] = await db.insert(projects).values(project).returning();
    return newProject;
  }
}
```

#### æŸ¥è¯¢æ“ä½œç¤ºä¾‹
```typescript
// âœ… æŸ¥è¯¢æŸä¸ªé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡
async function getTasksByProjectId(projectId: string) {
  const db = await getDb();
  // æ•°æ®åº“ç›´æ¥è¿‡æ»¤ï¼Œåªè¿”å›åŒ¹é…çš„æ•°æ®
  return db.select().from(tasks).where(eq(tasks.projectId, projectId));
}
```

#### å¹¶å‘æ§åˆ¶ç¤ºä¾‹
```typescript
// âœ… æ›´æ–°é¡¹ç›®ä½¿ç”¨äº‹åŠ¡
async function updateProject(project: Project) {
  const db = await getDb();
  // æ•°æ®åº“è‡ªåŠ¨å¤„ç†å¹¶å‘å’Œé”
  const [updated] = await db
    .update(projects)
    .set(project)
    .where(eq(projects.id, project.id))
    .returning();
  return updated;
}
```

### æ€§èƒ½ä¼°ç®—

å‡è®¾ï¼š
- 100 ä¸ªé¡¹ç›®
- æ¯ä¸ª 10 ä¸ªä»»åŠ¡ = 1000 ä¸ªä»»åŠ¡
- å»ºç«‹äº†é€‚å½“çš„ç´¢å¼•

| æ“ä½œ | å»¶è¿Ÿ | æ•°æ®é‡ | å¤æ‚åº¦ |
|------|------|--------|--------|
| è¯»å–æ‰€æœ‰é¡¹ç›® | ~10ms | 10KB | O(n) |
| æŸ¥è¯¢å•ä¸ªé¡¹ç›®ä»»åŠ¡ | ~5ms | 2KB | O(log n) |
| æ›´æ–°é¡¹ç›® | ~5ms | 2KB | O(log n) |
| æŒ‰çŠ¶æ€è¿‡æ»¤ | ~10ms | 20KB | O(log n) |

**ç»“è®º**ï¼šæ€§èƒ½ç¨³å®šï¼Œä¸å—æ•°æ®é‡å¢é•¿å½±å“ã€‚

---

## è¯¦ç»†å¯¹æ¯”è¡¨

| ç»´åº¦ | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | èƒœå‡ºè€… |
|------|---------|-----------|--------|
| **æ•°æ®ç±»å‹** | éç»“æ„åŒ–ï¼ˆæ–‡ä»¶ï¼‰ | ç»“æ„åŒ–ï¼ˆè¡¨æ ¼ï¼‰ | æ•°æ®åº“ |
| **CRUD æ“ä½œ** | â­â­ å¤æ‚ | â­â­â­â­â­ ç®€å• | æ•°æ®åº“ |
| **å…³è”æŸ¥è¯¢** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆJOINï¼‰ | æ•°æ®åº“ |
| **æ’åºè¿‡æ»¤** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆORDER BY, WHEREï¼‰ | æ•°æ®åº“ |
| **ç´¢å¼•æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆB-Tree, Hash ç­‰ï¼‰ | æ•°æ®åº“ |
| **äº‹åŠ¡æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆACIDï¼‰ | æ•°æ®åº“ |
| **å¹¶å‘æ§åˆ¶** | âŒ éœ€è‡ªå·±å®ç° | âœ… å†…ç½®é”æœºåˆ¶ | æ•°æ®åº“ |
| **æ•°æ®ä¸€è‡´æ€§** | â­â­ å·® | â­â­â­â­â­ å¼º | æ•°æ®åº“ |
| **è¯»å†™æ€§èƒ½** | â­â­ æ…¢ï¼ˆä¸‹è½½æ•´ä¸ªæ–‡ä»¶ï¼‰ | â­â­â­â­â­ å¿«ï¼ˆæ¯«ç§’çº§ï¼‰ | æ•°æ®åº“ |
| **æŸ¥è¯¢å»¶è¿Ÿ** | ~500ms+ | ~5-10ms | æ•°æ®åº“ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ æ— é™å®¹é‡ | â­â­â­â­ éœ€åˆ†åº“åˆ†è¡¨ | å¯¹è±¡å­˜å‚¨ |
| **æˆæœ¬** | â­â­â­â­â­ æŒ‰é‡è®¡è´¹ | â­â­â­â­ éœ€è¦ä¼˜åŒ– | å¯¹è±¡å­˜å‚¨ |
| **å­¦ä¹ æ›²çº¿** | â­â­â­ ç®€å• | â­â­ ä¸­ç­‰ | å¯¹è±¡å­˜å‚¨ |
| **å®ç°å¤æ‚åº¦** | â­â­ éœ€è‡ªå·±å®ç°é”ã€æŸ¥è¯¢ç­‰ | â­â­â­â­ ORM å°è£…åç®€å• | æ•°æ®åº“ |
| **é€‚ç”¨åœºæ™¯** | æ–‡ä»¶ã€å›¾ç‰‡ã€è§†é¢‘ | ç»“æ„åŒ–æ•°æ®ã€å…³ç³»æ•°æ® | - |

---

## é’ˆå¯¹æœ¬é¡¹ç›®çš„å¯¹æ¯”åˆ†æ

### æ•°æ®ç‰¹å¾åˆ†æ

| ç‰¹å¾ | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | è¯´æ˜ |
|------|---------|-----------|------|
| **ç»“æ„åŒ–æ•°æ®** | âŒ éœ€è¦æ‰‹åŠ¨è§£æ JSON | âœ… åŸç”Ÿæ”¯æŒ | é¡¹ç›®æ•°æ®æœ‰æ˜ç¡®çš„ schema |
| **åµŒå¥—æ•°ç»„** | â­â­ å¤æ‚ | â­â­â­â­â­ æ”¯æŒ | Project.developers[] ç­‰ |
| **JSONB å­—æ®µ** | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ | Task.type, dailyRecords[] ç­‰ |
| **å…³è”æŸ¥è¯¢** | âŒ ä¸æ”¯æŒ | âœ… JOIN æ”¯æŒ | Task â†’ Project å…³ç³» |
| **æ‰¹é‡æ“ä½œ** | â­â­ å¤æ‚ | âœ… æ‰¹é‡ INSERT/UPDATE | å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ |
| **å®æ—¶æ›´æ–°** | â­â­ éœ€é‡æ–°ä¸Šä¼  | â­â­â­â­â­ å¿«é€Ÿæ›´æ–° | è¿›åº¦æ¡å®æ—¶åˆ·æ–° |
| **å†å²è®°å½•** | â­â­ éœ€æ‰‹åŠ¨ç»´æŠ¤ | âœ… è‡ªåŠ¨å®¡è®¡ | HistoryRecord è¡¨ |

### åŠŸèƒ½éœ€æ±‚å¯¹æ¯”

| éœ€æ±‚ | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | è¯´æ˜ |
|------|---------|-----------|------|
| **åˆ›å»ºé¡¹ç›®** | â­â­ éœ€åŠ é” | â­â­â­â­â­ ç®€å• | æ•°æ®åº“æ”¯æŒäº‹åŠ¡ |
| **æŸ¥è¯¢é¡¹ç›®ä»»åŠ¡** | â­â­ ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ | â­â­â­â­â­ ç´¢å¼•æŸ¥è¯¢ | æ•°æ®åº“å¿« 100 å€ |
| **æ›´æ–°ä»»åŠ¡è¿›åº¦** | â­â­ è¯»å†™æ•´ä¸ªæ–‡ä»¶ | â­â­â­â­â­ å•æ¡æ›´æ–° | å®æ—¶æ€§å·®å¼‚å·¨å¤§ |
| **åˆ é™¤é¡¹ç›®** | â­â­ éœ€åˆ é™¤å…³è”æ•°æ® | âœ… å¤–é”®çº§è”åˆ é™¤ | æ•°æ®åº“è‡ªåŠ¨ç»´æŠ¤ä¸€è‡´æ€§ |
| **æŒ‰çŠ¶æ€è¿‡æ»¤** | â­â­ å†…å­˜è¿‡æ»¤ | â­â­â­â­â­ WHERE å­å¥ | æ•°æ®åº“æ€§èƒ½ç¨³å®š |
| **æ’åºæŸ¥è¯¢** | â­â­ å†…å­˜æ’åº | â­â­â­â­â­ ORDER BY | æ•°æ®åº“æ”¯æŒå¤šå­—æ®µæ’åº |
| **å¹¶å‘ç¼–è¾‘** | â­â­ éœ€è‡ªå·±å®ç°é” | â­â­â­â­â­ å†…ç½®é”æœºåˆ¶ | æ•°æ®åº“æ›´å¯é  |
| **æ•°æ®å¤‡ä»½** | â­â­â­â­ ç®€å• | â­â­â­ éœ€è¦é…ç½® | å¯¹è±¡å­˜å‚¨ç•¥ä¼˜ |

### æ€§èƒ½å¯¹æ¯”

å‡è®¾æœ‰ï¼š
- 100 ä¸ªé¡¹ç›®
- æ¯ä¸ª 10 ä¸ªä»»åŠ¡ = 1000 ä¸ªä»»åŠ¡
- ç”¨æˆ·æ¯æ¬¡æ“ä½œæŸ¥è¯¢ 5-10 ä¸ªä»»åŠ¡

| åœºæ™¯ | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | æ€§èƒ½æå‡ |
|------|---------|-----------|---------|
| **é¦–é¡µåŠ è½½**ï¼ˆæ‰€æœ‰é¡¹ç›®ï¼‰ | ~500ms | ~10ms | **50x** |
| **æ‰“å¼€é¡¹ç›®è¯¦æƒ…**ï¼ˆé¡¹ç›® + ä»»åŠ¡ï¼‰ | ~1000ms | ~20ms | **50x** |
| **æ›´æ–°ä»»åŠ¡è¿›åº¦** | ~1000ms | ~5ms | **200x** |
| **æŒ‰çŠ¶æ€è¿‡æ»¤ä»»åŠ¡** | ~500ms | ~10ms | **50x** |
| **åˆ é™¤é¡¹ç›®** | ~500ms | ~10ms | **50x** |
| **å¯¼å…¥ 100 ä¸ªé¡¹ç›®** | ~10000ms | ~200ms | **50x** |

### æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | è¯´æ˜ |
|------|---------|-----------|------|
| **å­˜å‚¨æˆæœ¬** | $0.023/GB/æœˆ | $0.125/GB/æœˆ | å¯¹è±¡å­˜å‚¨ä¾¿å®œ 5x |
| **è¯·æ±‚æˆæœ¬** | $0.0004/1000æ¬¡ | åŒ…å«åœ¨è¿æ¥ä¸­ | æ•°æ®åº“æ— é¢å¤–è¯·æ±‚è´¹ç”¨ |
| **æµé‡æˆæœ¬** | $0.1/GB | ä¸è®¡æµé‡ | å¯¹è±¡å­˜å‚¨æŒ‰æµé‡è®¡è´¹ |
| **æœˆåº¦ä¼°ç®—**ï¼ˆå‡è®¾ 1GB æ•°æ®ï¼Œ10ä¸‡æ¬¡è¯·æ±‚ï¼‰ | ~$2.5 | ~$0.13 | **æ•°æ®åº“ä¾¿å®œ 20x** |

**ç»“è®º**ï¼šå¯¹äºæœ¬é¡¹ç›®çš„ç»“æ„åŒ–æ•°æ®ï¼Œæ•°æ®åº“å­˜å‚¨æˆæœ¬æ›´ä½ã€‚

### ç»´æŠ¤æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | å¯¹è±¡å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ | è¯´æ˜ |
|------|---------|-----------|------|
| **é”æœºåˆ¶** | â­â­ éœ€è‡ªå·±å®ç° | âœ… å†…ç½® | æ•°æ®åº“çœåŠ› |
| **å¹¶å‘å†²çª** | â­â­ éœ€æ‰‹åŠ¨å¤„ç† | âœ… è‡ªåŠ¨å¤„ç† | æ•°æ®åº“çœåŠ› |
| **æ•°æ®è¿ç§»** | â­â­â­ JSON æ ¼å¼ | â­â­â­ SQL è„šæœ¬ | ç›¸å½“ |
| **æ•°æ®å¤‡ä»½** | â­â­â­â­ ç®€å• | â­â­â­ éœ€è¦é…ç½® | å¯¹è±¡å­˜å‚¨ç•¥ä¼˜ |
| **æ•…éšœæ¢å¤** | â­â­â­ ç®€å• | â­â­â­ WAL æ—¥å¿— | ç›¸å½“ |
| **ç›‘æ§å‘Šè­¦** | â­â­ éœ€è‡ªå·±å®ç° | â­â­â­â­ å†…ç½® | æ•°æ®åº“æ›´å®Œå–„ |

---

## å®ç°æ–¹æ¡ˆå¯¹æ¯”

### å¯¹è±¡å­˜å‚¨å®ç°æ¶æ„

```
Frontend
  â†“ HTTP POST /api/data
server.mjs
  â†“ 1. acquireLock()
  â†“ 2. readFile("data/projects.json")
  â†“ 3. parse JSON
  â†“ 4. modify data
  â†“ 5. writeFile("data/projects.json")
  â†“ 6. releaseLock()
S3 Storage
```

**ä»£ç è¡Œæ•°**ï¼š~800 è¡Œï¼ˆé”æœºåˆ¶ã€JSON è§£æã€é”™è¯¯å¤„ç†ç­‰ï¼‰

**æµ‹è¯•å¤æ‚åº¦**ï¼šâ­â­â­â­ éœ€æµ‹è¯•å¹¶å‘ã€é”ã€æ•°æ®ä¸€è‡´æ€§

**é£é™©ç‚¹**ï¼š
- å¹¶å‘å†²çª
- æ•°æ®æŸå
- æ€§èƒ½ç“¶é¢ˆ
- é”è¶…æ—¶
- JSON è§£æå¤±è´¥

### æ•°æ®åº“å­˜å‚¨å®ç°æ¶æ„

```
Frontend
  â†“ HTTP POST /api/data
server.mjs (or API Route)
  â†“ await projectManager.updateProject(project)
ProjectManager
  â†“ db.update(projects).set(project).where(...)
PostgreSQL
  â†“ è‡ªåŠ¨åŠ é”ã€æ›´æ–°ã€é‡Šæ”¾é”
  â†“ è¿”å›ç»“æœ
```

**ä»£ç è¡Œæ•°**ï¼š~300 è¡Œï¼ˆORM å°è£…ï¼Œç®€æ´æ¸…æ™°ï¼‰

**æµ‹è¯•å¤æ‚åº¦**ï¼šâ­â­ ORM å·²ç»è¿‡å……åˆ†æµ‹è¯•

**é£é™©ç‚¹**ï¼š
- Schema å˜æ›´ï¼ˆéœ€è¿ç§»ï¼‰
- è¿æ¥æ± è€—å°½ï¼ˆå¯é…ç½®ï¼‰
- æ…¢æŸ¥è¯¢ï¼ˆå¯é€šè¿‡ç´¢å¼•ä¼˜åŒ–ï¼‰

---

## æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒç»“è®º

**æ•°æ®åº“å­˜å‚¨ï¼ˆPostgreSQL + Drizzle ORMï¼‰æ˜¯æœ¬é¡¹ç›®çš„æœ€ä½³æ–¹æ¡ˆã€‚**

### å†³ç­–ä¾æ®

| ä¾æ® | æƒé‡ | å¯¹è±¡å­˜å‚¨å¾—åˆ† | æ•°æ®åº“å¾—åˆ† | è¯´æ˜ |
|------|------|------------|-----------|------|
| **åŠŸèƒ½æ€§** | 40% | 2/10 | 10/10 | æ•°æ®åº“åŠŸèƒ½å…¨é¢ |
| **æ€§èƒ½** | 30% | 2/10 | 10/10 | æ•°æ®åº“å¿« 50-200x |
| **å¯ç»´æŠ¤æ€§** | 15% | 4/10 | 9/10 | æ•°æ®åº“æ›´ç®€æ´ |
| **æˆæœ¬** | 10% | 6/10 | 9/10 | æ•°æ®åº“æ›´ä¾¿å®œ |
| **æ‰©å±•æ€§** | 5% | 10/10 | 8/10 | å¯¹è±¡å­˜å‚¨ç•¥ä¼˜ |
| **åŠ æƒæ€»åˆ†** | 100% | **3.1/10** | **9.7/10** | æ•°æ®åº“å®Œèƒœ |

### æ¨èæ–¹æ¡ˆ

#### âœ… æ–¹æ¡ˆï¼šä½¿ç”¨ PostgreSQL æ•°æ®åº“

**ç†ç”±**ï¼š
1. âœ… **å®Œç¾åŒ¹é…æ•°æ®ç»“æ„**ï¼šç»“æ„åŒ–æ•°æ®ï¼Œéœ€è¦å…³è”æŸ¥è¯¢
2. âœ… **æ€§èƒ½ä¼˜åŠ¿å·¨å¤§**ï¼šå“åº”é€Ÿåº¦æå‡ 50-200 å€
3. âœ… **å®ç°ç®€å•**ï¼šORM å°è£…åä»£ç ç®€æ´
4. âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šACID ç‰¹æ€§ä¿è¯æ•°æ®å®Œæ•´æ€§
5. âœ… **å¹¶å‘æ§åˆ¶**ï¼šå†…ç½®é”æœºåˆ¶ï¼Œå¯é ç¨³å®š
6. âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ å­—æ®µã€ç´¢å¼•ã€çº¦æŸç®€å•
7. âœ… **æˆæœ¬ä½**ï¼šä¼°ç®—ä¾¿å®œ 20x

#### âŒ ä¸æ¨èï¼šå¯¹è±¡å­˜å‚¨

**ç†ç”±**ï¼š
1. âŒ **ä¸é€‚åˆç»“æ„åŒ–æ•°æ®**ï¼šæ— æ³•æ‰§è¡Œ SQL æŸ¥è¯¢
2. âŒ **æ€§èƒ½å·®**ï¼šéœ€è¦ä¸‹è½½æ•´ä¸ªæ–‡ä»¶æ‰èƒ½è¯»å–
3. âŒ **å®ç°å¤æ‚**ï¼šéœ€è¦è‡ªå·±å®ç°é”ã€æŸ¥è¯¢ã€è¿‡æ»¤ç­‰
4. âŒ **å¹¶å‘é£é™©**ï¼šå®¹æ˜“äº§ç”Ÿæ•°æ®å†²çª
5. âŒ **ç»´æŠ¤æˆæœ¬é«˜**ï¼šéœ€è¦å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ

### æ··åˆæ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

å¦‚æœæœªæ¥éœ€è¦å­˜å‚¨**å›¾ç‰‡ã€é™„ä»¶ã€å¯¼å‡ºæ–‡ä»¶**ç­‰ï¼Œå¯ä»¥ä½¿ç”¨**æ··åˆæ–¹æ¡ˆ**ï¼š

```
PostgreSQLï¼ˆä¸»å­˜å‚¨ï¼‰
  â”œâ”€â”€ projects è¡¨
  â”œâ”€â”€ tasks è¡¨
  â”œâ”€â”€ taskTypes è¡¨
  â””â”€â”€ ...

S3 Storageï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰
  â”œâ”€â”€ attachments/       # é¡¹ç›®é™„ä»¶
  â”œâ”€â”€ exports/           # å¯¼å‡ºæ–‡ä»¶
  â””â”€â”€ avatars/           # ç”¨æˆ·å¤´åƒ
```

**å…³ç³»**ï¼š
- PostgreSQL å­˜å‚¨æ–‡ä»¶çš„ keyï¼ˆS3 è¿”å›çš„å®é™… keyï¼‰
- ä½¿ç”¨æ—¶é€šè¿‡ `generatePresignedUrl` ç”Ÿæˆè®¿é—®é“¾æ¥

### å®æ–½å»ºè®®

#### é˜¶æ®µ 1ï¼šæ•°æ®åº“åˆå§‹åŒ–ï¼ˆ1-2 å¤©ï¼‰
1. æ‰§è¡Œ `coze-coding-ai db generate-models` åŒæ­¥ schema
2. å®šä¹‰è¡¨ç»“æ„ï¼ˆprojects, tasks, taskTypes, pmos, productManagers, historyRecordsï¼‰
3. æ‰§è¡Œ `coze-coding-ai db upgrade` åˆ›å»ºè¡¨
4. å®ç° Manager å±‚ï¼ˆProjectManager, TaskManager ç­‰ï¼‰

#### é˜¶æ®µ 2ï¼šAPI å±‚æ”¹é€ ï¼ˆ2-3 å¤©ï¼‰
1. ä¿®æ”¹ `/api/data` æ¥å£ï¼Œä½¿ç”¨ Manager å±‚
2. ç§»é™¤æ–‡ä»¶è¯»å†™é€»è¾‘
3. æ·»åŠ äº‹åŠ¡æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰

#### é˜¶æ®µ 3ï¼šå‰ç«¯é€‚é…ï¼ˆ1 å¤©ï¼‰
1. ç¡®ä¿å‰ç«¯æ•°æ®æ ¼å¼å…¼å®¹
2. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
3. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚æœéœ€è¦ï¼‰

#### é˜¶æ®µ 4ï¼šæ•°æ®è¿ç§»ï¼ˆ1 å¤©ï¼‰
1. å¯¼å‡ºç°æœ‰ JSON æ•°æ®
2. æ‰¹é‡æ’å…¥æ•°æ®åº“
3. éªŒè¯æ•°æ®å®Œæ•´æ€§

**æ€»è€—æ—¶**ï¼š5-7 å¤©

---

## é™„å½•ï¼šæ•°æ®è¿ç§»æ–¹æ¡ˆ

### ä»å¯¹è±¡å­˜å‚¨è¿ç§»åˆ°æ•°æ®åº“

```typescript
// migration.ts
import { S3Storage } from "coze-coding-dev-sdk";
import { getDb } from "coze-coding-dev-sdk";
import { projectManager, taskManager } from "./storage/database";

const storage = new S3Storage({
  endpointUrl: process.env.COZE_BUCKET_ENDPOINT_URL,
  bucketName: process.env.COZE_BUCKET_NAME,
});

async function migrate() {
  // 1. ä»å¯¹è±¡å­˜å‚¨è¯»å–æ•°æ®
  const projectsData = await storage.readFile({
    fileKey: "data/projects.json",
  });
  const tasksData = await storage.readFile({
    fileKey: "data/tasks.json",
  });

  const projects = JSON.parse(projectsData.toString());
  const tasks = JSON.parse(tasksData.toString());

  // 2. æ‰¹é‡æ’å…¥æ•°æ®åº“
  const db = await getDb();
  await db.transaction(async (tx) => {
    // æ’å…¥é¡¹ç›®
    for (const project of projects) {
      await projectManager.createProject(project);
    }

    // æ’å…¥ä»»åŠ¡
    for (const task of tasks) {
      await taskManager.createTask(task);
    }
  });

  console.log("è¿ç§»å®Œæˆ");
}

migrate();
```

---

## ç»“è®º

**æ¨èä½¿ç”¨ PostgreSQL æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆã€‚**

æ•°æ®åº“å­˜å‚¨åœ¨åŠŸèƒ½æ€§ã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ã€æˆæœ¬ç­‰æ–¹é¢éƒ½**å…¨é¢ä¼˜äº**å¯¹è±¡å­˜å‚¨ï¼Œæ˜¯æœ¬é¡¹ç›®çš„æœ€ä½³é€‰æ‹©ã€‚å¦‚æœæœªæ¥éœ€è¦å­˜å‚¨æ–‡ä»¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ··åˆæ–¹æ¡ˆï¼ˆæ•°æ®åº“ + å¯¹è±¡å­˜å‚¨ï¼‰ã€‚

**é¢„æœŸæ”¶ç›Š**ï¼š
- âš¡ æ€§èƒ½æå‡ **50-200 å€**
- ğŸ’° æˆæœ¬é™ä½ **20 å€**
- ğŸ”§ ä»£ç å‡å°‘ **60%**
- ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§æå‡ **10 å€**
- ğŸš€ ç»´æŠ¤æˆæœ¬é™ä½ **50%**
